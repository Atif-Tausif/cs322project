{% extends "base.html" %}

{% block title %}Manager Dashboard - EBA Express{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4"><i class="fas fa-tachometer-alt"></i> Manager Dashboard</h1>
    
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5>Pending Approvals</h5>
                    <h2>{{ pending_users|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5>Pending Complaints</h5>
                    <h2>{{ pending_complaints|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5>Orders with Bids</h5>
                    <h2>{{ orders_with_bids|length }}</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pending User Approvals -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-user-clock"></i> Pending User Approvals</h5>
        </div>
        <div class="card-body">
            {% if pending_users %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Registered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in pending_users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email or 'N/A' }}</td>
                            <td>{{ user.role|title }}</td>
                            <td>{{ user.created_at[:10] }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('main.manager_approve_user', user_id=user.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-success">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('main.manager_reject_user', user_id=user.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </form>
                                <button class="btn btn-sm btn-warning" onclick="showCloseAccountModal('{{ user.id }}')">
                                    <i class="fas fa-ban"></i> Close Account
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No pending approvals</p>
            {% endif %}
        </div>
    </div>
    
    <!-- All Orders -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-shopping-bag"></i> All Orders</h5>
        </div>
        <div class="card-body">
            {% if pending_orders %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in pending_orders %}
                        <tr>
                            <td>{{ order.id[:8] }}...</td>
                            <td>
                                {% for item in order.items %}
                                    {% if item.dish_name %}
                                    <div>{{ item.dish_name }} (Qty: {{ item.quantity }})</div>
                                    {% endif %}
                                {% endfor %}
                            </td>
                            <td>${{ order.total|round(2) }}</td>
                            <td>
                                <span class="badge bg-{{ 'warning' if order.status == 'pending' else 'info' if order.status == 'preparing' else 'success' if order.status == 'ready' else 'secondary' }}">
                                    {{ order.status|title }}
                                </span>
                            </td>
                            <td>{{ order.created_at[:19] }}</td>
                            <td>
                                <select class="form-select form-select-sm" onchange="updateOrderStatus('{{ order.id }}', this.value)" style="width: auto; display: inline-block;">
                                    <option value="{{ order.status }}" selected>{{ order.status|title }}</option>
                                    {% if order.status != 'pending' %}<option value="pending">Pending</option>{% endif %}
                                    {% if order.status != 'preparing' %}<option value="preparing">Preparing</option>{% endif %}
                                    {% if order.status != 'ready' %}<option value="ready">Ready</option>{% endif %}
                                    {% if order.status != 'delivering' %}<option value="delivering">Delivering</option>{% endif %}
                                    {% if order.status != 'delivered' %}<option value="delivered">Delivered</option>{% endif %}
                                    {% if order.status != 'cancelled' %}<option value="cancelled">Cancelled</option>{% endif %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No pending orders</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Pending Complaints -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-exclamation-triangle"></i> Pending Complaints</h5>
        </div>
        <div class="card-body">
            {% if pending_complaints %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>From</th>
                            <th>Against</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for complaint in pending_complaints %}
                        <tr>
                            <td>
                                <span class="badge bg-{{ 'danger' if complaint.complaint_type == 'complaint' else 'success' }}">
                                    {{ complaint.complaint_type|title }}
                                </span>
                            </td>
                            <td>{{ complaint.complainant_name or 'Unknown' }}</td>
                            <td>{{ complaint.target_name or 'Unknown' }} ({{ complaint.target_type|title }})</td>
                            <td>{{ complaint.description[:50] }}{% if complaint.description|length > 50 %}...{% endif %}</td>
                            <td>{{ complaint.created_at[:10] }}</td>
                            <td>
                                {% if complaint.disputed %}
                                <span class="badge bg-warning">Disputed</span>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-primary" 
                                        data-complaint-id="{{ complaint.id }}"
                                        data-complainant="{{ complaint.complainant_name or 'Unknown' }}"
                                        data-target="{{ complaint.target_name or 'Unknown' }}"
                                        data-target-type="{{ complaint.target_type }}"
                                        data-complaint-type="{{ complaint.complaint_type }}"
                                        data-description="{{ complaint.description|replace('"', '&quot;')|replace("'", '&#39;') }}"
                                        data-disputed="{{ 1 if complaint.disputed else 0 }}"
                                        onclick="showResolveComplaintModalFromButton(this)">
                                    <i class="fas fa-gavel"></i> Resolve
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No pending complaints</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Orders Ready for Delivery -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-truck"></i> Orders Ready for Delivery</h5>
        </div>
        <div class="card-body">
            {% if orders_with_bids %}
            {% for item in orders_with_bids %}
            <div class="card mb-3">
                <div class="card-header">
                    <strong>Order #{{ item.order.id[:8] }}</strong> - Total: ${{ item.order.total|round(2) }}
                </div>
                <div class="card-body">
                    <h6>Delivery Bids:</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Delivery Person</th>
                                <th>Bid Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bid in item.bids %}
                            <tr class="{{ 'table-success' if bid == item.bids[0] else '' }}">
                                <td>{{ bid.delivery_person_name }}</td>
                                <td>${{ bid.bid_amount|round(2) }}</td>
                                <td>
                                    {% if bid == item.bids[0] %}
                                    <span class="badge bg-success">Lowest</span>
                                    {% endif %}
                                    <button class="btn btn-sm btn-primary" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#acceptBidModal{{ bid.id|replace('.', '_')|replace('-', '_') }}"
                                            {% if bid != item.bids[0] %}title="Requires memo"{% endif %}>
                                        Accept
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Accept Bid Modal -->
            {% for bid in item.bids %}
            {% set bid_id_safe = bid.id|replace('.', '_')|replace('-', '_') %}
            <div class="modal fade" id="acceptBidModal{{ bid_id_safe }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Accept Delivery Bid</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form id="acceptBidForm{{ bid_id_safe }}" class="accept-bid-form" data-bid-id="{{ bid.id }}">
                            <input type="hidden" name="order_id" value="{{ item.order.id }}">
                            <input type="hidden" name="bid_id" value="{{ bid.id }}">
                            <div class="modal-body">
                                <p><strong>Delivery Person:</strong> {{ bid.delivery_person_name }}</p>
                                <p><strong>Bid Amount:</strong> ${{ bid.bid_amount|round(2) }}</p>
                                {% if bid != item.bids[0] %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    This is not the lowest bid. A memo is required.
                                </div>
                                <div class="mb-3">
                                    <label for="memo{{ bid_id_safe }}" class="form-label">Justification Memo *</label>
                                    <textarea class="form-control" id="memo{{ bid_id_safe }}" name="memo" rows="3" required></textarea>
                                </div>
                                {% else %}
                                <input type="hidden" name="memo" value="">
                                {% endif %}
                                <div id="acceptBidMessage{{ bid_id_safe }}" class="mt-2"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary accept-bid-submit-btn" data-bid-id="{{ bid.id }}">
                                    <span class="btn-text">Accept Bid</span>
                                    <span class="btn-loading" style="display: none;">
                                        <i class="fas fa-spinner fa-spin"></i> Processing...
                                    </span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endfor %}
            {% else %}
            <p class="text-muted">No orders with bids available</p>
            {% endif %}
            
            {% if orders_without_bids %}
            <div class="mt-4">
                <h6>Orders Ready (No Bids Yet):</h6>
                <ul class="list-group">
                    {% for order in orders_without_bids %}
                    <li class="list-group-item">
                        Order #{{ order.id[:8] }} - Total: ${{ order.total|round(2) }} - Waiting for delivery bids
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Flagged Knowledge Base Entries -->
    {% if flagged_kb %}
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-flag"></i> Flagged Knowledge Base Entries</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Answer</th>
                            <th>Author</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in flagged_kb %}
                        <tr>
                            <td>{{ entry.question }}</td>
                            <td>{{ entry.answer[:50] }}...</td>
                            <td>{{ entry.author_id or 'System' }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('main.manager_approve_knowledge', entry_id=entry.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-success">Keep</button>
                                </form>
                                <form method="POST" action="{{ url_for('main.manager_remove_knowledge', entry_id=entry.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Remove entry and ban author?')">Remove & Ban</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Pending Knowledge Base Submissions -->
    {% if pending_kb %}
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-book"></i> Pending Knowledge Base Submissions</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Answer</th>
                            <th>Author</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in pending_kb %}
                        <tr>
                            <td>{{ entry.question }}</td>
                            <td>{{ entry.answer[:50] }}...</td>
                            <td>{{ entry.author_id or 'Unknown' }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('main.manager_approve_knowledge', entry_id=entry.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-success">Approve</button>
                                </form>
                                <form method="POST" action="{{ url_for('main.manager_remove_knowledge', entry_id=entry.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-danger">Reject</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Manage Accounts -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-users"></i> Manage Accounts</h5>
            <small class="text-muted">Manage all user accounts including customers, VIPs, and employees</small>
        </div>
        <div class="card-body">
            {% if all_users %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in all_users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ user.role|title }}</span>
                            </td>
                            <td>{{ user.email or 'N/A' }}</td>
                            <td>
                                {% if user.blacklisted %}
                                <span class="badge bg-danger">Blacklisted</span>
                                {% elif user.role in ['chef', 'delivery'] %}
                                    {% if user.approved %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                    {% endif %}
                                {% elif user.role in ['customer', 'vip'] %}
                                    {% if user.approved %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-warning">Pending Approval</span>
                                    {% endif %}
                                {% else %}
                                <span class="badge bg-secondary">{{ 'Active' if user.approved else 'Inactive' }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="showAccountModal('{{ user.id }}', '{{ user.username }}', '{{ user.role }}', '{{ 1 if user.approved else 0 }}', '{{ 1 if user.blacklisted else 0 }}')">
                                        <i class="fas fa-edit"></i> Manage
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No users found</p>
            {% endif %}
        </div>
    </div>
    
    <!-- HR Management -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-users-cog"></i> Human Resources Management</h5>
        </div>
        <div class="card-body">
            {% if employees %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Salary</th>
                            <th>Rating</th>
                            <th>Complaints</th>
                            <th>Compliments</th>
                            <th>Demotions</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emp in employees %}
                        <tr>
                            <td>{{ emp.username }}</td>
                            <td>{{ emp.role|title }}</td>
                            <td>${{ emp.salary|round(2) }}</td>
                            <td>{{ emp.rating|round(1) if emp.rating > 0 else 'N/A' }}</td>
                            <td>{{ emp.complaints_count }}</td>
                            <td>{{ emp.compliments }}</td>
                            <td>{{ emp.demotions }}</td>
                            <td>
                                {% if emp.approved %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="showHRModal('{{ emp.id }}', '{{ emp.username }}', '{{ emp.role }}', '{{ emp.salary }}', '{{ 1 if emp.approved else 0 }}')">
                                        <i class="fas fa-edit"></i> Manage
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No employees found</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Order Ratings Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-star"></i> Order Ratings</h5>
        </div>
        <div class="card-body">
            {% if rated_orders %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Chef</th>
                            <th>Food Rating</th>
                            <th>Delivery Rating</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in rated_orders %}
                        <tr>
                            <td>{{ order.id[:8] }}...</td>
                            <td>{{ order.customer_name }}</td>
                            <td>{{ order.chef_names }}</td>
                            <td>
                                {% if order.food_rating %}
                                <div>
                                    {% for i in range(5) %}
                                        {% if i < order.food_rating %}
                                        <i class="fas fa-star text-warning"></i>
                                        {% else %}
                                        <i class="far fa-star text-warning"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="ms-2">({{ order.food_rating }}/5)</span>
                                </div>
                                {% else %}
                                <span class="text-muted">Not rated</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if order.delivery_rating %}
                                <div>
                                    {% for i in range(5) %}
                                        {% if i < order.delivery_rating %}
                                        <i class="fas fa-star text-warning"></i>
                                        {% else %}
                                        <i class="far fa-star text-warning"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="ms-2">({{ order.delivery_rating }}/5)</span>
                                </div>
                                {% else %}
                                <span class="text-muted">Not rated</span>
                                {% endif %}
                            </td>
                            <td>{{ order.created_at[:10] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No rated orders yet</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Account Management Modal -->
<div class="modal fade" id="accountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Account: <span id="accountUserName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="accountUserId">
                <input type="hidden" id="accountUserRole">
                <div class="mb-3">
                    <label class="form-label">Action</label>
                    <select class="form-select" id="accountAction" onchange="updateAccountForm()">
                        <option value="approve">Approve Account</option>
                        <option value="hire">Hire as Employee</option>
                        <option value="blacklist">Blacklist User</option>
                        <option value="unblacklist">Remove Blacklist</option>
                        <option value="close">Close Account</option>
                    </select>
                </div>
                <div class="mb-3" id="accountRoleGroup" style="display: none;">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="accountRole">
                        <option value="chef">Chef</option>
                        <option value="delivery">Delivery</option>
                    </select>
                    <small class="form-text text-muted">Note: Maximum 2 active employees per role</small>
                </div>
                <div class="mb-3" id="accountSalaryGroup" style="display: none;">
                    <label class="form-label">Initial Salary ($)</label>
                    <input type="number" class="form-control" id="accountSalary" step="0.01" min="0" value="5000.00">
                    <small class="form-text text-muted">Default: $5000 for Chef, $3000 for Delivery</small>
                </div>
                <div class="mb-3" id="accountBlacklistGroup" style="display: none;">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="accountBlacklist">
                        <label class="form-check-label" for="accountBlacklist">
                            Blacklist this user (prevent future registration)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="accountRefundBalance">
                        <label class="form-check-label" for="accountRefundBalance">
                            Refund balance when closing account
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAccountAction()">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- HR Management Modal -->
<div class="modal fade" id="hrModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Employee: <span id="hrEmployeeName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hrEmployeeId">
                <div class="mb-3">
                    <label class="form-label">Action</label>
                    <select class="form-select" id="hrAction" onchange="updateHRForm()">
                        <option value="set_salary">Set Salary</option>
                        <option value="raise">Raise Salary</option>
                        <option value="cut">Cut Salary</option>
                        <option value="fire">Fire Employee</option>
                        <option value="hire">Hire Employee</option>
                    </select>
                </div>
                <div class="mb-3" id="hrAmountGroup">
                    <label class="form-label" id="hrAmountLabel">Amount</label>
                    <input type="number" class="form-control" id="hrAmount" step="0.01" min="0">
                    <small class="form-text text-muted" id="hrAmountHelp">Enter amount in dollars or percentage (0.1 = 10%)</small>
                </div>
                <div class="mb-3" id="hrRoleGroup" style="display: none;">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="hrRole">
                        <option value="chef">Chef</option>
                        <option value="delivery">Delivery</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitHRAction()">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- Account Closure Modal -->
<div class="modal fade" id="closeAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Close Customer Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="closeAccountUserId">
                <p>This will close the account and refund the customer's balance.</p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="closeAccountBlacklist">
                    <label class="form-check-label" for="closeAccountBlacklist">
                        Blacklist this user (prevent future registration)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitCloseAccount()">Close Account</button>
            </div>
        </div>
    </div>
</div>

<!-- Resolve Complaint Modal -->
<div class="modal fade" id="resolveComplaintModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resolve Complaint</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="resolveComplaintForm">
                <input type="hidden" id="resolveComplaintId" name="complaint_id">
                <div class="modal-body">
                    <p><strong>From:</strong> <span id="resolveComplainantName"></span></p>
                    <p><strong>Against:</strong> <span id="resolveTargetName"></span> (<span id="resolveTargetType"></span>)</p>
                    <p><strong>Description:</strong> <span id="resolveDescription"></span></p>
                    <div class="alert alert-warning" id="resolveDisputedWarning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i> This complaint has been disputed by the target.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Resolution</label>
                        <select class="form-select" name="resolution" required id="resolveComplaintResolution" onchange="updateResolveComplaintInfo()">
                            <option value="carry_out">Carry Out (Complaint is valid)</option>
                            <option value="overrule">Overrule (Complaint is false)</option>
                        </select>
                        <div id="resolveComplaintInfo" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Resolve</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Make all functions globally accessible and ensure jQuery is available
(function() {
    function initManagerDashboard() {
        if (typeof jQuery === 'undefined') {
            console.log('jQuery not loaded yet, retrying...');
            setTimeout(initManagerDashboard, 100);
            return;
        }
        
        const $ = jQuery;
        
        // Make all functions globally accessible
        window.updateOrderStatus = function(orderId, newStatus) {
            if (!confirm(`Update order status to ${newStatus}?`)) {
                return;
            }
            
            $.ajax({
                url: '/api/v1/order/update-status',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    order_id: orderId,
                    status: newStatus
                }),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert(response.message || 'Failed to update order status');
                    }
                },
                error: function(xhr) {
                    console.error('Error updating order status:', xhr);
                    alert('Error updating order status');
                }
            });
        };
        
        window.showAccountModal = function(userId, userName, currentRole, isApproved, isBlacklisted) {
            $('#accountUserId').val(userId);
            $('#accountUserName').text(userName);
            $('#accountUserRole').val(currentRole);
            $('#accountAction').val('approve');
            window.updateAccountForm();
            $('#accountModal').modal('show');
        };
        
        window.updateAccountForm = function() {
            const action = $('#accountAction').val();
            const currentRole = $('#accountUserRole').val();
            
            // Hide all optional groups
            $('#accountRoleGroup').hide();
            $('#accountSalaryGroup').hide();
            $('#accountBlacklistGroup').hide();
            
            if (action === 'hire') {
                $('#accountRoleGroup').show();
                $('#accountSalaryGroup').show();
                $('#accountRole').val('chef');
                $('#accountSalary').val('5000.00');
            } else if (action === 'close') {
                $('#accountBlacklistGroup').show();
            }
        };
        
        window.submitAccountAction = function() {
            const userId = $('#accountUserId').val();
            const action = $('#accountAction').val();
            const role = $('#accountRole').val();
            const salary = parseFloat($('#accountSalary').val()) || 0;
            const blacklist = $('#accountBlacklist').is(':checked');
            const refundBalance = $('#accountRefundBalance').is(':checked');
            
            const data = {
                user_id: userId,
                action: action
            };
            
            if (action === 'hire') {
                if (!role) {
                    alert('Please select a role');
                    return;
                }
                data.role = role;
                data.amount = salary;
            } else if (action === 'close') {
                data.blacklist = blacklist;
                data.refund_balance = refundBalance;
            }
            
            $.ajax({
                url: '/manager/account/manage',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        $('#accountModal').modal('hide');
                        location.reload();
                    } else {
                        alert(response.message || 'Failed to perform action');
                    }
                },
                error: function(xhr) {
                    console.error('Error performing account action:', xhr);
                    const errorMsg = xhr.responseJSON?.message || 'Error performing action';
                    alert(errorMsg);
                }
            });
        };
        
        window.showHRModal = function(empId, empName, empRole, empSalary, isActive) {
            $('#hrEmployeeId').val(empId);
            $('#hrEmployeeName').text(empName);
            $('#hrRole').val(empRole);
            $('#hrAmount').val('');
            window.updateHRForm();
            $('#hrModal').modal('show');
        };
        
        window.updateHRForm = function() {
            const action = $('#hrAction').val();
            
            if (action === 'fire') {
                $('#hrAmountGroup').hide();
                $('#hrRoleGroup').hide();
            } else if (action === 'hire') {
                $('#hrAmountGroup').hide();
                $('#hrRoleGroup').show();
            } else {
                $('#hrAmountGroup').show();
                $('#hrRoleGroup').hide();
                if (action === 'set_salary') {
                    $('#hrAmountLabel').text('Salary Amount ($)');
                    $('#hrAmountHelp').text('Enter the new salary amount in dollars');
                } else if (action === 'raise') {
                    $('#hrAmountLabel').text('Raise Amount');
                    $('#hrAmountHelp').text('Enter amount in dollars or percentage (0.1 = 10% raise)');
                } else if (action === 'cut') {
                    $('#hrAmountLabel').text('Cut Amount');
                    $('#hrAmountHelp').text('Enter amount in dollars or percentage (0.1 = 10% cut)');
                }
            }
        };
        
        window.submitHRAction = function() {
            const empId = $('#hrEmployeeId').val();
            const action = $('#hrAction').val();
            const amount = parseFloat($('#hrAmount').val()) || 0;
            const role = $('#hrRole').val();
            
            const data = {
                employee_id: empId,
                action: action,
                amount: amount
            };
            
            if (action === 'hire') {
                data.role = role;
            }
            
            $.ajax({
                url: '/manager/hr/update',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        $('#hrModal').modal('hide');
                        location.reload();
                    } else {
                        alert(response.message || 'Failed to update employee');
                    }
                },
                error: function(xhr) {
                    console.error('Error updating employee:', xhr);
                    alert('Error updating employee');
                }
            });
        };
        
        window.showCloseAccountModal = function(userId) {
            $('#closeAccountUserId').val(userId);
            $('#closeAccountBlacklist').prop('checked', false);
            $('#closeAccountModal').modal('show');
        };
        
        window.submitCloseAccount = function() {
            const userId = $('#closeAccountUserId').val();
            const blacklist = $('#closeAccountBlacklist').is(':checked');
            
            $.ajax({
                url: '/manager/account/close',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    user_id: userId,
                    blacklist: blacklist
                }),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        $('#closeAccountModal').modal('hide');
                        location.reload();
                    } else {
                        alert(response.message || 'Failed to close account');
                    }
                },
                error: function(xhr) {
                    console.error('Error closing account:', xhr);
                    alert('Error closing account');
                }
            });
        };
        
        window.showResolveComplaintModalFromButton = function(button) {
            const complaintId = $(button).data('complaint-id');
            const complainantName = $(button).data('complainant');
            const targetName = $(button).data('target');
            const targetType = $(button).data('target-type');
            const complaintType = $(button).data('complaint-type');
            const description = $(button).data('description');
            const isDisputed = $(button).data('disputed');
            
            window.showResolveComplaintModal(complaintId, complainantName, targetName, targetType, complaintType, description, isDisputed);
        };
        
        window.showResolveComplaintModal = function(complaintId, complainantName, targetName, targetType, complaintType, description, isDisputed) {
            $('#resolveComplaintId').val(complaintId);
            $('#resolveComplainantName').text(complainantName || 'Unknown');
            $('#resolveTargetName').text(targetName || 'Unknown');
            $('#resolveTargetType').text(targetType || 'Unknown');
            $('#resolveDescription').text(description || '');
            $('#resolveComplaintResolution').val('carry_out');
            
            if (isDisputed == '1' || isDisputed === 1) {
                $('#resolveDisputedWarning').show();
            } else {
                $('#resolveDisputedWarning').hide();
            }
            
            // Store for use in update function
            $('#resolveComplaintModal').data('targetType', targetType);
            $('#resolveComplaintModal').data('complaintType', complaintType);
            $('#resolveComplaintModal').data('complainantName', complainantName);
            
            window.updateResolveComplaintInfo();
            $('#resolveComplaintModal').modal('show');
        };
        
        window.updateResolveComplaintInfo = function() {
            const resolution = $('#resolveComplaintResolution').val();
            const targetType = $('#resolveComplaintModal').data('targetType');
            const complaintType = $('#resolveComplaintModal').data('complaintType');
            const complainantName = $('#resolveComplaintModal').data('complainantName');
            const infoDiv = $('#resolveComplaintInfo');
            
            if (resolution === 'carry_out') {
                if (complaintType === 'complaint') {
                    if (targetType === 'chef' || targetType === 'delivery') {
                        infoDiv.html('<div class="alert alert-info"><i class="fas fa-info-circle"></i> <strong>If carried out:</strong> The complaint will remain on the employee\'s record and affect their performance evaluation. This may impact their salary and employment status.</div>');
                    } else {
                        infoDiv.html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> <strong>If carried out:</strong> The target will receive a warning. Multiple warnings may result in account restrictions.</div>');
                    }
                } else {
                    infoDiv.html('<div class="alert alert-success"><i class="fas fa-check-circle"></i> <strong>If carried out:</strong> The target will benefit from this compliment.</div>');
                }
            } else {
                // Overrule
                infoDiv.html('<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> <strong>If overruled:</strong> ' + (complainantName || 'The complainant') + ' will receive a warning (if customer/VIP) or complaint (if employee). The complaint will be removed from the target\'s record (complaint -1).</div>');
            }
        };
        
        // Set up accept bid form handler using event delegation
        // This ensures it works even if modals are created dynamically
        console.log('Setting up accept bid form handler');
        
        // Remove any existing handlers to avoid duplicates
        $(document).off('submit', '.accept-bid-form');
        
        $(document).on('submit', '.accept-bid-form', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Accept bid form submitted!');
            
            const form = $(this);
            const formId = form.attr('id');
            const actualBidId = form.data('bid-id'); // Get the actual bid ID from data attribute
            console.log('Form ID:', formId, 'Actual Bid ID:', actualBidId);
            
            if (!formId || !formId.startsWith('acceptBidForm')) {
                console.error('Invalid form ID:', formId);
                alert('Error: Invalid form');
                return false;
            }
            
            // Use the safe ID for finding elements, but actual bid ID for submission
            const bidIdSafe = formId.replace('acceptBidForm', '');
            const messageDiv = $('#acceptBidMessage' + bidIdSafe);
            const submitBtn = form.find('button[type="submit"]');
            const btnText = submitBtn.find('.btn-text');
            const btnLoading = submitBtn.find('.btn-loading');
            
            const orderId = form.find('input[name="order_id"]').val();
            // Use actual bid ID from data attribute or hidden input
            const bidIdValue = actualBidId || form.find('input[name="bid_id"]').val();
            const memo = form.find('textarea[name="memo"], input[name="memo"]').val() || '';
            
            console.log('Accepting bid:', { orderId, bidId: bidIdValue, memo });
            
            if (!orderId || !bidIdValue) {
                console.error('Missing required fields:', { orderId, bidId: bidIdValue });
                messageDiv.html('<div class="alert alert-danger">Missing required information.</div>');
                return false;
            }
            
            // Check if memo is required (not the lowest bid)
            const memoField = form.find('textarea[name="memo"]');
            if (memoField.length > 0 && memoField.prop('required') && !memo.trim()) {
                messageDiv.html('<div class="alert alert-danger">Memo is required for non-lowest bids.</div>');
                return false;
            }
            
            // Disable button and show loading
            submitBtn.prop('disabled', true);
            if (btnText.length) btnText.hide();
            if (btnLoading.length) btnLoading.show();
            messageDiv.html('');
            
            // Submit using form data (the route expects form data, not JSON)
            const formData = new FormData();
            formData.append('order_id', orderId);
            formData.append('bid_id', bidIdValue);
            formData.append('memo', memo);
            
            console.log('Submitting bid acceptance to /manager/delivery/accept...');
            
            fetch('/manager/delivery/accept', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Accept bid response status:', response.status, 'redirected:', response.redirected);
                if (response.redirected || response.ok) {
                    // The route redirects, so reload the page
                    console.log('Bid accepted successfully, reloading page...');
                    location.reload();
                } else {
                    return response.text().then(text => {
                        console.error('Error response:', text);
                        messageDiv.html('<div class="alert alert-danger">Error accepting bid: ' + (text || 'Unknown error') + '</div>');
                        submitBtn.prop('disabled', false);
                        if (btnText.length) btnText.show();
                        if (btnLoading.length) btnLoading.hide();
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageDiv.html('<div class="alert alert-danger">Error accepting bid: ' + error.message + '</div>');
                submitBtn.prop('disabled', false);
                if (btnText.length) btnText.show();
                if (btnLoading.length) btnLoading.hide();
            });
            
            return false;
        });
        
        console.log('Accept bid form handler registered');
        
        // Initialize other event handlers
        $(document).ready(function() {
            console.log('Manager dashboard initialized');
            
            // Account role change handler
            $('#accountRole').on('change', function() {
                const role = $(this).val();
                if (role === 'chef') {
                    $('#accountSalary').val('5000.00');
                } else {
                    $('#accountSalary').val('3000.00');
                }
            });
            
            // Complaint resolution form handler
            $('#resolveComplaintForm').on('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const complaintId = $('#resolveComplaintId').val();
                const resolution = $('#resolveComplaintResolution').val();
                
                console.log('Resolving complaint:', complaintId, resolution);
                
                if (!complaintId || !resolution) {
                    alert('Please select a resolution');
                    return false;
                }
                
                // Submit using form data (the route expects form data, not JSON)
                const formData = new FormData();
                formData.append('resolution', resolution);
                
                fetch('/manager/complaint/resolve/' + complaintId, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log('Response status:', response.status, 'redirected:', response.redirected);
                    if (response.redirected || response.ok) {
                        // The route redirects, so reload the page
                        location.reload();
                    } else {
                        return response.text().then(text => {
                            console.error('Error response:', text);
                            alert('Error resolving complaint. Please try again.');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error resolving complaint. Please try again.');
                });
                
                return false;
            });
        });
    }
    
    // Start initialization 
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initManagerDashboard);
    } else {
        initManagerDashboard();
    }
    
    // Set up accept bid handler - wait for jQuery to be fully loaded
    function setupAcceptBidHandler() {
        if (typeof window.jQuery === 'undefined' && typeof jQuery === 'undefined') {
            console.log('jQuery not available yet, retrying in 100ms...');
            setTimeout(setupAcceptBidHandler, 100);
            return;
        }
        
        const $ = window.jQuery || jQuery;
        
        console.log('Setting up accept bid form handler (jQuery available)');
        
        // Remove any existing handlers to avoid duplicates
        $(document).off('submit', '.accept-bid-form');
        $(document).off('click', '.accept-bid-submit-btn');
        
        // Handler for form submission
        $(document).on('submit', '.accept-bid-form', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Global accept bid form handler triggered!');
            
            const form = $(this);
            const formId = form.attr('id');
            const actualBidId = form.data('bid-id'); // Get the actual bid ID from data attribute
            console.log('Form ID:', formId, 'Actual Bid ID:', actualBidId);
            
            if (!formId || !formId.startsWith('acceptBidForm')) {
                console.error('Invalid form ID:', formId);
                alert('Error: Invalid form');
                return false;
            }
            
            // Use the safe ID for finding elements, but actual bid ID for submission
            const bidIdSafe = formId.replace('acceptBidForm', '');
            const messageDiv = $('#acceptBidMessage' + bidIdSafe);
            const submitBtn = form.find('button[type="submit"]');
            const btnText = submitBtn.find('.btn-text');
            const btnLoading = submitBtn.find('.btn-loading');
            
            const orderId = form.find('input[name="order_id"]').val();
            // Use actual bid ID from data attribute or hidden input
            const bidIdValue = actualBidId || form.find('input[name="bid_id"]').val();
            const memo = form.find('textarea[name="memo"], input[name="memo"]').val() || '';
            
            console.log('Accepting bid:', { orderId, bidId: bidIdValue, memo });
            
            if (!orderId || !bidIdValue) {
                console.error('Missing required fields');
                messageDiv.html('<div class="alert alert-danger">Missing required information.</div>');
                return false;
            }
            
            const memoField = form.find('textarea[name="memo"]');
            if (memoField.length > 0 && memoField.prop('required') && !memo.trim()) {
                messageDiv.html('<div class="alert alert-danger">Memo is required for non-lowest bids.</div>');
                return false;
            }
            
            submitBtn.prop('disabled', true);
            if (btnText.length) btnText.hide();
            if (btnLoading.length) btnLoading.show();
            messageDiv.html('');
            
            const formData = new FormData();
            formData.append('order_id', orderId);
            formData.append('bid_id', bidIdValue);
            formData.append('memo', memo);
            
            console.log('Submitting to /manager/delivery/accept...');
            
            fetch('/manager/delivery/accept', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status, 'redirected:', response.redirected);
                if (response.redirected || response.ok) {
                    console.log('Success, reloading page...');
                    // Small delay to ensure backend has saved the data
                    setTimeout(function() {
                        location.reload();
                    }, 100);
                } else {
                    return response.text().then(text => {
                        console.error('Error response:', text);
                        messageDiv.html('<div class="alert alert-danger">Error accepting bid: ' + (text || 'Unknown error') + '</div>');
                        submitBtn.prop('disabled', false);
                        if (btnText.length) btnText.show();
                        if (btnLoading.length) btnLoading.hide();
                    });
                }
            })
            .catch(error => {
                console.error('Exception:', error);
                messageDiv.html('<div class="alert alert-danger">Error accepting bid: ' + error.message + '</div>');
                submitBtn.prop('disabled', false);
                if (btnText.length) btnText.show();
                if (btnLoading.length) btnLoading.hide();
            });
            
            return false;
        });
        
        // Also handle button clicks directly as a backup
        $(document).on('click', '.accept-bid-submit-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Accept bid button clicked directly!');
            
            const btn = $(this);
            const form = btn.closest('form');
            
            if (!form.length) {
                console.error('Form not found for button');
                alert('Error: Form not found');
                return false;
            }
            
            // Trigger form submission
            console.log('Triggering form submit...');
            form.trigger('submit');
            
            return false;
        });
        
        console.log('Accept bid form handler registered successfully');
    }
    
    // Start setting up handler - wait for DOM and jQuery
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(setupAcceptBidHandler, 200);
        });
    } else {
        setTimeout(setupAcceptBidHandler, 200);
    }
    
    // Also try immediately in case everything is already loaded
    setupAcceptBidHandler();
    
    // Debug: Log when page is fully loaded
    window.addEventListener('load', function() {
        console.log('Page fully loaded. jQuery available:', typeof jQuery !== 'undefined');
        console.log('Accept bid forms on page:', document.querySelectorAll('.accept-bid-form').length);
        setupAcceptBidHandler(); // Try one more time after everything loads
    });
})();
</script>
{% endblock %}
