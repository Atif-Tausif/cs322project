{% extends "base.html" %}

{% block title %}Shopping Cart - EBA Express{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4"><i class="fas fa-shopping-cart"></i> Shopping Cart</h1>
    
    {% if cart_items %}
    <div class="row">
        <div class="col-md-8">
            {% for item in cart_items %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            {% if item.dish.image %}
                            <img src="{{ item.dish.image }}" class="img-fluid rounded" alt="{{ item.dish.name }}">
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h5>{{ item.dish.name }}</h5>
                            <p class="text-muted mb-0">{{ item.dish.description[:100] }}...</p>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Quantity</label>
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="updateQuantity('{{ item.dish_id }}', -1)" type="button">-</button>
                                <span class="quantity-display" id="quantity-{{ item.dish_id }}">{{ item.quantity }}</span>
                                <button class="quantity-btn" onclick="updateQuantity('{{ item.dish_id }}', 1)" type="button">+</button>
                            </div>
                            <input type="hidden" class="cart-quantity" 
                                   data-dish-id="{{ item.dish_id }}" 
                                   id="qty-{{ item.dish_id }}"
                                   value="{{ item.quantity }}" min="1" max="999">
                        </div>
                        <div class="col-md-2 text-end">
                            <strong>${{ item.subtotal|round(2) }}</strong>
                            <br>
                            <button class="btn btn-sm btn-danger mt-2 remove-from-cart" 
                                    data-dish-id="{{ item.dish_id }}">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>${{ total|round(2) }}</span>
                    </div>
                    {% if discount > 0 %}
                    <div class="d-flex justify-content-between mb-2 text-success">
                        <span>VIP Discount (5%):</span>
                        <span>-${{ discount|round(2) }}</span>
                    </div>
                    {% endif %}
                    {% set subtotal_after_discount = total - discount %}
                    {% set delivery_fee = subtotal_after_discount * 0.10 %}
                    {% if session.user and session.user.role == 'vip' %}
                    {% set available_free = (session.user.free_deliveries_earned or 0) - (session.user.free_deliveries_used or 0) %}
                    {% if available_free > 0 %}
                    <div class="d-flex justify-content-between mb-2 text-info">
                        <span><i class="fas fa-gift"></i> Free Delivery Applied:</span>
                        <span>-${{ delivery_fee|round(2) }}</span>
                    </div>
                    {% set delivery_fee = 0.0 %}
                    {% endif %}
                    {% endif %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Delivery Fee (10%):</span>
                        <span>${{ delivery_fee|round(2) }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <strong>Total:</strong>
                        <strong>${{ (subtotal_after_discount + delivery_fee)|round(2) }}</strong>
                    </div>
                    <div class="mb-3">
                        <label for="deliveryAddress" class="form-label">
                            <i class="fas fa-map-marker-alt"></i> Delivery Address <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="deliveryAddress" rows="3" placeholder="Enter your delivery address..." required></textarea>
                        <small class="text-muted">Please provide your complete delivery address</small>
                    </div>
                    <button type="button" class="btn btn-primary w-100" onclick="placeOrder()">
                        <i class="fas fa-check"></i> Place Order
                    </button>
                    <a href="/menu" class="btn btn-outline-secondary w-100 mt-2">
                        <i class="fas fa-arrow-left"></i> Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
        <p class="text-muted">Your cart is empty. <a href="/menu">Browse menu</a> to add items!</p>
    </div>
    {% endif %}
</div>

<script>
// Quantity update function
function updateQuantity(dishId, change) {
    const hiddenInput = document.getElementById('qty-' + dishId);
    const display = document.getElementById('quantity-' + dishId);
    
    if (!hiddenInput || !display) return;
    
    let currentQty = parseInt(hiddenInput.value) || 1;
    let newQty = currentQty + change;
    
    // Enforce limits
    if (newQty < 1) newQty = 1;
    if (newQty > 999) newQty = 999;
    
    if (newQty === currentQty) return;
    
    // Update display immediately for better UX
    display.textContent = newQty;
    hiddenInput.value = newQty;
    
    // Update via API
    $.ajax({
        url: '/api/v1/cart/update',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            dish_id: dishId,
            quantity: newQty
        }),
        success: function(response) {
            if (response.success) {
                $('#cart-count').text(response.cart_count);
                // Reload to update totals
                setTimeout(function() {
                    location.reload();
                }, 300);
            } else {
                // Revert on error
                display.textContent = currentQty;
                hiddenInput.value = currentQty;
                alert(response.message || 'Failed to update quantity');
            }
        },
        error: function() {
            // Revert on error
            display.textContent = currentQty;
            hiddenInput.value = currentQty;
            alert('Error updating quantity');
        }
    });
}

// Override placeOrder function for cart page - ensure it runs after jQuery is loaded
$(document).ready(function() {
    // Override the global placeOrder function
    window.placeOrder = function() {
        // Read items from current DOM state instead of template variables
        const items = [];
        $('.cart-quantity').each(function() {
            const dishId = $(this).data('dish-id');
            const quantity = parseInt($(this).val()) || 1;
            
            if (dishId && quantity > 0) {
                items.push({
                    dish_id: dishId,
                    quantity: quantity
                });
            }
        });
        
        if (items.length === 0) {
            alert('Your cart is empty');
            return;
        }
        
        // Get delivery address - try multiple selectors to be safe
        const deliveryAddressInput = $('#deliveryAddress');
        let deliveryAddress = '';
        if (deliveryAddressInput.length > 0) {
            deliveryAddress = deliveryAddressInput.val().trim();
        } else {
            // Fallback: try to find by name or other attributes
            const altInput = $('textarea[id*="address"], textarea[name*="address"]');
            if (altInput.length > 0) {
                deliveryAddress = altInput.val().trim();
            }
        }
        
        if (!deliveryAddress) {
            alert('Please enter your delivery address');
            if (deliveryAddressInput.length > 0) {
                deliveryAddressInput.focus();
            }
            return;
        }
        
        $.ajax({
            url: '/api/v1/order',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                items: items,
                delivery_address: deliveryAddress
            }),
            success: function(response) {
                if (response.success) {
                    alert('Order placed successfully!');
                    // Use page transition
                    const transition = document.getElementById('pageTransition');
                    if (transition) {
                        transition.classList.add('active');
                        setTimeout(function() {
                            window.location.href = '/orders';
                        }, 400);
                    } else {
                        window.location.href = '/orders';
                    }
                } else {
                    alert(response.message || 'Failed to place order');
                }
            },
            error: function(xhr) {
                let errorMsg = 'Error placing order';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                alert(errorMsg);
            }
        });
    };
});
</script>
{% endblock %}
