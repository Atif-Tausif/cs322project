{% extends "base.html" %}

{% block title %}Menu - EBA Express{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4"><i class="fas fa-book-open"></i> Our Menu</h1>
    
    <!-- Search and Filters -->
    <div class="menu-filters mb-4">
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search dishes...">
                    <button class="btn btn-primary" id="searchBtn">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <select class="form-select" id="sortSelect">
                    <option value="popular">Most Popular</option>
                    <option value="rating">Highest Rated</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="newest">Newest First</option>
                </select>
            </div>
        </div>
        
        <!-- Category Filters -->
        <div class="mb-3">
            <strong>Categories:</strong>
            <div class="btn-group flex-wrap" role="group">
                <button type="button" class="btn btn-outline-primary filter-btn active" data-category="all">
                    All
                </button>
                <button type="button" class="btn btn-outline-primary filter-btn" data-category="appetizers">
                    Appetizers
                </button>
                <button type="button" class="btn btn-outline-primary filter-btn" data-category="main">
                    Main Course
                </button>
                <button type="button" class="btn btn-outline-primary filter-btn" data-category="desserts">
                    Desserts
                </button>
                <button type="button" class="btn btn-outline-primary filter-btn" data-category="beverages">
                    Beverages
                </button>
            </div>
        </div>
        
        <!-- Chef Filter -->
        <div class="mb-3">
            <strong>Chef:</strong>
            <div class="btn-group flex-wrap" role="group">
                <button type="button" class="btn btn-outline-secondary filter-btn active" data-chef="all">
                    All Chefs
                </button>
                {% for chef in chefs|default([]) %}
                <button type="button" class="btn btn-outline-secondary filter-btn" data-chef="{{ chef.id }}">
                    {{ chef.name }}
                </button>
                {% endfor %}
            </div>
        </div>
        
        <!-- Flavor Profile Filter (All Customers) -->
        {% if session.user and session.user.role in ['customer', 'vip'] %}
        <div class="mb-3">
            <strong><i class="fas fa-star text-warning"></i> Flavor Profile Filter:</strong>
            <div class="btn-group flex-wrap" role="group">
                <button type="button" class="btn btn-outline-warning filter-btn" data-flavor="spicy">
                    <i class="fas fa-fire"></i> Spicy
                </button>
                <button type="button" class="btn btn-outline-warning filter-btn" data-flavor="sweet">
                    <i class="fas fa-cookie"></i> Sweet
                </button>
                <button type="button" class="btn btn-outline-warning filter-btn" data-flavor="savory">
                    <i class="fas fa-drumstick-bite"></i> Savory
                </button>
                <button type="button" class="btn btn-outline-warning filter-btn" data-flavor="tangy">
                    <i class="fas fa-lemon"></i> Tangy
                </button>
            </div>
        </div>
        {% endif %}
        
        <!-- Price Range Filter -->
        <div class="row">
            <div class="col-md-6">
                <label for="minPrice" class="form-label">Min Price: $<span id="minPriceValue">0</span></label>
                <input type="range" class="form-range" id="minPrice" min="0" max="100" value="0" step="5">
            </div>
            <div class="col-md-6">
                <label for="maxPrice" class="form-label">Max Price: $<span id="maxPriceValue">100</span></label>
                <input type="range" class="form-range" id="maxPrice" min="0" max="100" value="100" step="5">
            </div>
        </div>
    </div>
    
    <!-- Results Count -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <p class="text-muted mb-0">
            Showing <strong id="resultsCount">0</strong> dishes
        </p>
        <div>
            <button class="btn btn-sm btn-outline-secondary" id="gridView">
                <i class="fas fa-th"></i> Grid
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="listView">
                <i class="fas fa-list"></i> List
            </button>
        </div>
    </div>
    
    <!-- Dishes Grid -->
    <div class="row" id="dishesGrid">
        <!-- Dishes will be loaded here via JavaScript -->
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading delicious dishes...</p>
        </div>
    </div>
    
    <!-- Pagination -->
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Pagination buttons will be generated here -->
        </ul>
    </nav>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/menu.js') }}"></script>
<script>
// Initialize menu page
$(document).ready(function() {
    let currentFilters = {
        search: '',
        category: 'all',
        chef: 'all',
        flavor: null,
        minPrice: 0,
        maxPrice: 100,
        sort: 'popular',
        page: 1
    };
    
    // Load initial dishes
    loadDishes();
    
    // Search functionality
    $('#searchBtn').on('click', function() {
        currentFilters.search = $('#searchInput').val();
        currentFilters.page = 1;
        loadDishes();
    });
    
    $('#searchInput').on('keypress', function(e) {
        if (e.which === 13) {
            $('#searchBtn').click();
        }
    });
    
    // Category filters
    $('.filter-btn[data-category]').on('click', function() {
        $('.filter-btn[data-category]').removeClass('active');
        $(this).addClass('active');
        currentFilters.category = $(this).data('category');
        currentFilters.page = 1;
        loadDishes();
    });
    
    // Chef filters
    $('.filter-btn[data-chef]').on('click', function() {
        $('.filter-btn[data-chef]').removeClass('active');
        $(this).addClass('active');
        currentFilters.chef = $(this).data('chef');
        currentFilters.page = 1;
        loadDishes();
    });
    
    // Flavor filters
    $('.filter-btn[data-flavor]').on('click', function() {
        $(this).toggleClass('active');
        const activeFlavors = $('.filter-btn[data-flavor].active').map(function() {
            return $(this).data('flavor');
        }).get();
        currentFilters.flavor = activeFlavors.length > 0 ? activeFlavors : null;
        currentFilters.page = 1;
        loadDishes();
    });
    
    // Sort
    $('#sortSelect').on('change', function() {
        currentFilters.sort = $(this).val();
        loadDishes();
    });
    
    // Price range
    $('#minPrice, #maxPrice').on('input', function() {
        const min = parseInt($('#minPrice').val());
        const max = parseInt($('#maxPrice').val());
        $('#minPriceValue').text(min);
        $('#maxPriceValue').text(max);
        currentFilters.minPrice = min;
        currentFilters.maxPrice = max;
    });
    
    $('#minPrice, #maxPrice').on('change', function() {
        loadDishes();
    });
    
    // View toggle
    $('#gridView').on('click', function() {
        $('#dishesGrid').removeClass('list-view');
    });
    
    $('#listView').on('click', function() {
        $('#dishesGrid').addClass('list-view');
    });
    
    /**
     * Load dishes from API
     */
    function loadDishes() {
        // Prepare data for AJAX - handle flavor array properly
        const ajaxData = {};
        for (let key in currentFilters) {
            if (currentFilters[key] !== null && currentFilters[key] !== undefined) {
                if (Array.isArray(currentFilters[key])) {
                    // Send array as multiple parameters with same key
                    ajaxData[key] = currentFilters[key];
                } else {
                    ajaxData[key] = currentFilters[key];
                }
            }
        }
        
        $.ajax({
            url: '/api/v1/menu',
            method: 'GET',
            data: ajaxData,
            traditional: true, // Use traditional serialization for arrays
            beforeSend: function() {
                $('#dishesGrid').html(`
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `);
            },
            success: function(response) {
                if (response.success) {
                    displayDishes(response.dishes);
                    updatePagination(response.total, response.page, response.per_page);
                    $('#resultsCount').text(response.total);
                } else {
                    $('#dishesGrid').html(`
                        <div class="col-12 text-center py-5">
                            <p class="text-muted">No dishes found matching your criteria.</p>
                        </div>
                    `);
                }
            },
            error: function() {
                $('#dishesGrid').html(`
                    <div class="col-12 text-center py-5">
                        <p class="text-danger">Error loading dishes. Please try again.</p>
                    </div>
                `);
            }
        });
    }
    
    /**
     * Display dishes in grid
     */
    function displayDishes(dishes) {
        const grid = $('#dishesGrid');
        grid.empty();
        
        if (dishes.length === 0) {
            grid.html(`
                <div class="col-12 text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No dishes found. Try adjusting your filters.</p>
                </div>
            `);
            return;
        }
        
        dishes.forEach(dish => {
            const card = createDishCard(dish);
            grid.append(card);
        });
    }
    
    /**
     * Create dish card HTML
     */
    function createDishCard(dish) {
        const vipBadge = dish.vip_only ? '<span class="badge bg-warning text-dark position-absolute top-0 start-0 m-2"><i class="fas fa-crown"></i> VIP Only</span>' : '';
        const matchScore = dish.match_score ? `<small class="text-success"><i class="fas fa-check-circle"></i> ${dish.match_score}% match</small>` : '';
        
        return `
            <div class="col-md-4 mb-4">
                <div class="card dish-card h-100">
                    <div class="position-relative">
                        <img src="${dish.image || '/static/images/default_dish.png'}" class="card-img-top" alt="${dish.name}">
                        ${vipBadge}
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">${dish.name}</h5>
                        <p class="card-text text-muted">${dish.description.substring(0, 100)}...</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h5 mb-0">$${dish.price}</span>
                            <div class="rating">
                                ${'<i class="fas fa-star text-warning"></i>'.repeat(Math.round(dish.rating))}
                                ${'<i class="far fa-star text-warning"></i>'.repeat(5 - Math.round(dish.rating))}
                                <span class="text-muted ms-1">(${dish.rating})</span>
                            </div>
                        </div>
                        <small class="text-muted d-block mb-2">
                            <i class="fas fa-user-chef"></i> Chef ${dish.chef_name}
                        </small>
                        ${matchScore}
                    </div>
                    <div class="card-footer bg-white">
                        <a href="/dish/${dish.id}" class="btn btn-primary w-100">
                            <i class="fas fa-info-circle"></i> View Details
                        </a>
                    </div>
                </div>
            </div>
        `;
    }
    
    /**
     * Update pagination
     */
    function updatePagination(total, currentPage, perPage) {
        const totalPages = Math.ceil(total / perPage);
        const pagination = $('#pagination');
        pagination.empty();
        
        if (totalPages <= 1) return;
        
        // Previous button
        pagination.append(`
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
            </li>
        `);
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                pagination.append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `);
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
            }
        }
        
        // Next button
        pagination.append(`
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
            </li>
        `);
        
        // Handle pagination clicks
        pagination.find('a').on('click', function(e) {
            e.preventDefault();
            const page = $(this).data('page');
            if (page && page !== currentPage) {
                currentFilters.page = page;
                loadDishes();
                $('html, body').animate({ scrollTop: 0 }, 300);
            }
        });
    }
});
</script>
{% endblock %}