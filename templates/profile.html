{% extends "base.html" %}

{% block title %}Profile - EBA Express{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4"><i class="fas fa-user-circle"></i> My Profile</h1>
    
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <i class="fas fa-user fa-4x text-primary mb-3"></i>
                    <h3>{{ user.username }}</h3>
                    <p class="text-muted">{{ user.email or 'No email' }}</p>
                    {% if user.role == 'vip' %}
                    <span class="badge bg-warning text-dark">
                        <i class="fas fa-crown"></i> VIP Member
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h5>Account Information</h5>
                    <p><strong>Balance:</strong> ${{ user.balance|round(2) }}</p>
                    <p><strong>Total Spent:</strong> ${{ user.total_spent|round(2) }}</p>
                    <p><strong>Orders:</strong> {{ user.orders_count }}</p>
                    {% if user.role == 'vip' %}
                    <p class="text-success">
                        <strong>Free Deliveries:</strong> 
                        {{ (user.free_deliveries_earned or 0) - (user.free_deliveries_used or 0) }} available
                        ({{ user.free_deliveries_earned or 0 }} earned, {{ user.free_deliveries_used or 0 }} used)
                    </p>
                    <p class="text-muted small">
                        <i class="fas fa-info-circle"></i> Earn 1 free delivery for every 3 orders
                    </p>
                    {% endif %}
                    {% if user.warnings > 0 %}
                    <p class="text-danger">
                        <strong>Warnings:</strong> {{ user.warnings }}
                    </p>
                    {% endif %}
                    {% if user.role in ['customer', 'vip'] %}
                    <hr>
                    <button type="button" class="btn btn-outline-danger btn-sm" id="requestClosureBtn">
                        <i class="fas fa-user-times"></i> Request Account Closure
                    </button>
                    <div id="closureMessage" class="mt-2"></div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Add Money Section -->
            <div class="card mt-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-wallet"></i> Add Money to Account</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Add funds to your account balance to place orders.</p>
                    <div class="input-group mb-3">
                        <span class="input-group-text">$</span>
                        <input type="number" 
                               class="form-control" 
                               id="depositAmount"
                               step="0.01" 
                               min="0.01"
                               placeholder="Enter amount"
                               value="10.00">
                        <button type="button" class="btn btn-primary" id="depositBtn">
                            <i class="fas fa-plus-circle"></i> Add Money
                        </button>
                    </div>
                    <div id="depositMessage"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <!-- Flavor Preferences (All Customers) -->
            {% if user.role in ['customer', 'vip'] and flavor_preferences %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Flavor Preferences</h5>
                    <small class="text-muted">Based on your order history</small>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Order History Analysis:</strong>
                        <div class="mt-2">
                            {% for flavor, percentage in flavor_preferences.items() %}
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <small>
                                        {% if flavor == 'spicy' %}
                                        <i class="fas fa-fire text-danger"></i> Spicy
                                        {% elif flavor == 'sweet' %}
                                        <i class="fas fa-cookie text-warning"></i> Sweet
                                        {% elif flavor == 'savory' %}
                                        <i class="fas fa-drumstick-bite text-primary"></i> Savory
                                        {% elif flavor == 'tangy' %}
                                        <i class="fas fa-lemon text-success"></i> Tangy
                                        {% else %}
                                        {{ flavor|title }}
                                        {% endif %}
                                    </small>
                                    <small><strong>{{ percentage|round(1) }}%</strong></small>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar 
                                        {% if flavor == 'spicy' %}bg-danger
                                        {% elif flavor == 'sweet' %}bg-warning
                                        {% elif flavor == 'savory' %}bg-primary
                                        {% elif flavor == 'tangy' %}bg-success
                                        {% else %}bg-secondary{% endif %}" 
                                        role="progressbar" 
                                        style="width: {{ percentage|round(1) }}%">
                                        {{ percentage|round(1) }}%
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if user.role == 'vip' and flavor_analysis %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Flavor Profile (VIP Analysis)</h5>
                </div>
                <div class="card-body">
                    {% if flavor_analysis.dominant_flavor %}
                    <p><strong>Dominant Flavor:</strong> 
                        <span class="badge bg-primary">{{ flavor_analysis.dominant_flavor|title }}</span>
                    </p>
                    {% endif %}
                    <div class="mb-3">
                        <strong>Profile Scores:</strong>
                        <div class="mt-2">
                            {% for flavor, score in flavor_analysis.profile.items() %}
                            <div class="mb-2">
                                <small>{{ flavor|title }}:</small>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" style="width: {{ (score / 10 * 100)|round }}%">
                                        {{ score|round(1) }}/10
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Complaints Against Me -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-exclamation-triangle"></i> Complaints Against Me</h5>
                </div>
                <div class="card-body">
                    {% if my_complaints %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for complaint in my_complaints %}
                                <tr>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if complaint.complaint_type == 'complaint' else 'success' }}">
                                            {{ complaint.complaint_type|title }}
                                        </span>
                                    </td>
                                    <td>{{ complaint.description[:50] }}...</td>
                                    <td>
                                        {% if complaint.status == 'disputed' %}
                                        <span class="badge bg-warning">Disputed</span>
                                        {% elif complaint.status == 'resolved' %}
                                        <span class="badge bg-{{ 'success' if complaint.dispute_resolution == 'dismissed' else 'danger' }}">
                                            {{ complaint.dispute_resolution|title if complaint.dispute_resolution else 'Resolved' }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if complaint.status == 'pending' and not complaint.disputed %}
                                        <button class="btn btn-sm btn-warning" onclick="disputeComplaint('{{ complaint.id }}')">
                                            <i class="fas fa-gavel"></i> Dispute
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No complaints filed against you</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- File a Complaint/Compliment Section -->
            {% if user.role in ['customer', 'vip'] %}
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-comment-alt"></i> File a Complaint or Compliment</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Submit a complaint or compliment about a chef or delivery person. The manager will review it and take appropriate action.</p>
                    <form id="complaintForm">
                        <div class="mb-3">
                            <label for="complaintType" class="form-label">Type</label>
                            <select class="form-select" id="complaintType" required>
                                <option value="complaint">Complaint</option>
                                <option value="compliment">Compliment</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="complaintTargetType" class="form-label">About</label>
                            <select class="form-select" id="complaintTargetType" required onchange="updateComplaintTargets()">
                                <option value="">Select type...</option>
                                <option value="chef">Chef</option>
                                <option value="delivery">Delivery Person</option>
                                <option value="customer">Customer</option>
                            </select>
                        </div>
                        <div class="mb-3" id="targetSelectGroup" style="display: none;">
                            <label for="complaintTargetId" class="form-label">Select Person</label>
                            <select class="form-select" id="complaintTargetId" required>
                                <option value="">Select a person...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="complaintDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="complaintDescription" rows="4" 
                                      placeholder="Please describe in detail..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Submit
                        </button>
                    </form>
                    <div id="complaintMessage" class="mt-3"></div>
                </div>
            </div>
            {% endif %}
            
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-receipt"></i> Recent Orders</h5>
                </div>
                <div class="card-body">
                    {% if orders %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in orders %}
                                <tr>
                                    <td><a href="/orders#order-{{ order.id }}">{{ order.id[:8] }}...</a></td>
                                    <td>{{ order.created_at[:10] }}</td>
                                    <td>${{ order.total|round(2) }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if order.status == 'delivered' else 'warning' }}">
                                            {{ order.status|title }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No orders yet. <a href="/menu">Browse menu</a> to get started!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Store chefs, delivery persons, and customers data
const chefsData = {{ chefs|tojson }};
const deliveryPersonsData = {{ delivery_persons|tojson }};
const customersData = {{ customers|tojson }};

// Make updateComplaintTargets globally accessible
window.updateComplaintTargets = function() {
    if (typeof jQuery === 'undefined') {
        console.log('jQuery not loaded yet');
        return;
    }
    
    const targetType = jQuery('#complaintTargetType').val();
    const targetSelect = jQuery('#complaintTargetId');
    const targetGroup = jQuery('#targetSelectGroup');
    
    if (!targetType) {
        targetGroup.hide();
        targetSelect.html('<option value="">Select a person...</option>');
        return;
    }
    
    targetGroup.show();
    targetSelect.html('<option value="">Select a person...</option>');
    
    let targets = [];
    if (targetType === 'chef') {
        targets = chefsData || [];
    } else if (targetType === 'delivery') {
        targets = deliveryPersonsData || [];
    } else if (targetType === 'customer') {
        targets = customersData || [];
    }
    
    if (targets && targets.length > 0) {
        targets.forEach(function(person) {
            targetSelect.append(`<option value="${person.id}">${person.username}</option>`);
        });
    } else {
        targetSelect.append('<option value="">No ' + targetType + 's available</option>');
    }
};

window.disputeComplaint = function(complaintId) {
    if (!confirm('Are you sure you want to dispute this complaint?')) {
        return;
    }
    
    if (typeof jQuery === 'undefined') {
        alert('jQuery not loaded');
        return;
    }
    
    jQuery.ajax({
        url: '/api/v1/complaint/dispute',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ complaint_id: complaintId }),
        success: function(response) {
            if (response.success) {
                alert('Complaint disputed successfully');
                location.reload();
            } else {
                alert(response.message || 'Failed to dispute complaint');
            }
        },
        error: function() {
            alert('Error disputing complaint');
        }
    });
};

// Handle complaint form submission
(function() {
    function initComplaintForm() {
        if (typeof jQuery === 'undefined') {
            console.log('jQuery not loaded yet, retrying complaint form...');
            setTimeout(initComplaintForm, 100);
            return;
        }
        
        jQuery(document).ready(function($) {
            console.log('Setting up complaint form');
            
            // Use event delegation to ensure form is found
            $(document).on('submit', '#complaintForm', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Complaint form submitted');
                const complaintType = $('#complaintType').val();
                const targetType = $('#complaintTargetType').val();
                const targetId = $('#complaintTargetId').val();
                const description = $('#complaintDescription').val().trim();
                const messageDiv = $('#complaintMessage');
                const submitBtn = $(this).find('button[type="submit"]');
                
                if (!complaintType || !targetType || !targetId || !description) {
                    messageDiv.html('<div class="alert alert-danger">Please fill in all fields.</div>');
                    return false;
                }
                
                // Disable button during request
                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Submitting...');
                messageDiv.html('');
                
                console.log('Sending complaint/compliment:', { target_id: targetId, target_type: targetType, complaint_type: complaintType, description: description });
                
                $.ajax({
                    url: '/api/v1/complaint',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        target_id: targetId,
                        target_type: targetType,
                        complaint_type: complaintType,
                        description: description
                    }),
                    success: function(response) {
                        console.log('Complaint response:', response);
                        if (response.success) {
                            const typeText = complaintType === 'compliment' ? 'Compliment' : 'Complaint';
                            messageDiv.html('<div class="alert alert-success">' + typeText + ' submitted successfully! The manager will review it.</div>');
                            $('#complaintForm')[0].reset();
                            $('#targetSelectGroup').hide();
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            messageDiv.html('<div class="alert alert-danger">' + (response.message || 'Failed to submit') + '</div>');
                            submitBtn.prop('disabled', false).html('<i class="fas fa-paper-plane"></i> Submit');
                        }
                    },
                    error: function(xhr) {
                        console.error('Complaint error:', xhr);
                        const errorMsg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Error submitting. Please try again.';
                        messageDiv.html('<div class="alert alert-danger">' + errorMsg + '</div>');
                        submitBtn.prop('disabled', false).html('<i class="fas fa-paper-plane"></i> Submit');
                    }
                });
                
                return false;
            });
        });
    }
    
    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initComplaintForm);
    } else {
        initComplaintForm();
    }
})();

// Handle deposit
(function() {
    function initDeposit() {
        if (typeof jQuery === 'undefined') {
            console.log('jQuery not loaded yet, retrying...');
            setTimeout(initDeposit, 100);
            return;
        }
        
        jQuery(document).ready(function($) {
            console.log('Profile page loaded, setting up deposit button');
            
            // Use event delegation or direct binding
            $(document).on('click', '#depositBtn', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Deposit button clicked');
                const amount = parseFloat($('#depositAmount').val());
                const messageDiv = $('#depositMessage');
                const btn = $(this);
                
                if (isNaN(amount) || amount <= 0) {
                    messageDiv.html('<div class="alert alert-danger">Please enter a valid amount greater than $0.</div>');
                    return false;
                }
                
                if (amount > 10000) {
                    messageDiv.html('<div class="alert alert-warning">Maximum deposit amount is $10,000.</div>');
                    return false;
                }
                
                // Disable button during request
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
                messageDiv.html('');
                
                console.log('Sending deposit request for amount:', amount);
                
                $.ajax({
                    url: '/api/v1/deposit',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ amount: amount }),
                    success: function(response) {
                        console.log('Deposit response:', response);
                        if (response.success) {
                            messageDiv.html(`<div class="alert alert-success">${response.message}</div>`);
                            $('#depositAmount').val('10.00');
                            // Reload page after 1 second to show updated balance
                            setTimeout(function() {
                                location.reload();
                            }, 1000);
                        } else {
                            messageDiv.html(`<div class="alert alert-danger">${response.message || 'Failed to add money'}</div>`);
                            btn.prop('disabled', false).html('<i class="fas fa-plus-circle"></i> Add Money');
                        }
                    },
                    error: function(xhr) {
                        console.error('Deposit error:', xhr);
                        const errorMsg = xhr.responseJSON?.message || 'Error adding money. Please try again.';
                        messageDiv.html(`<div class="alert alert-danger">${errorMsg}</div>`);
                        btn.prop('disabled', false).html('<i class="fas fa-plus-circle"></i> Add Money');
                    }
                });
                
                return false;
            });
            
            // Allow Enter key to trigger deposit
            $(document).on('keypress', '#depositAmount', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $('#depositBtn').click();
                }
            });
        });
    }
    
    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDeposit);
    } else {
        initDeposit();
    }
})();

// Handle account closure request
(function() {
    function initAccountClosure() {
        if (typeof jQuery === 'undefined') {
            console.log('jQuery not loaded yet, retrying...');
            setTimeout(initAccountClosure, 100);
            return;
        }
        
        jQuery(document).ready(function($) {
            $(document).on('click', '#requestClosureBtn', function(e) {
                e.preventDefault();
                
                if (!confirm('Are you sure you want to request account closure? This request will be sent to the manager for review. You will not be able to use your account until the manager makes a decision.')) {
                    return false;
                }
                
                const btn = $(this);
                const messageDiv = $('#closureMessage');
                
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Requesting...');
                messageDiv.html('');
                
                $.ajax({
                    url: '/api/v1/account/closure/request',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({}),
                    success: function(response) {
                        if (response.success) {
                            messageDiv.html('<div class="alert alert-success">' + response.message + '</div>');
                            btn.hide();
                        } else {
                            messageDiv.html('<div class="alert alert-danger">' + (response.message || 'Failed to request account closure') + '</div>');
                            btn.prop('disabled', false).html('<i class="fas fa-user-times"></i> Request Account Closure');
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.message || 'Error requesting account closure. Please try again.';
                        messageDiv.html('<div class="alert alert-danger">' + errorMsg + '</div>');
                        btn.prop('disabled', false).html('<i class="fas fa-user-times"></i> Request Account Closure');
                    }
                });
                
                return false;
            });
        });
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAccountClosure);
    } else {
        initAccountClosure();
    }
})();
</script>
{% endblock %}
