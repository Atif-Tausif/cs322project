{% extends "base.html" %}

{% block title %}Order History - EBA Express{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4"><i class="fas fa-receipt"></i> My Orders</h1>
    
    {% if orders %}
    <div class="row">
        {% for order in orders %}
        <div class="col-md-12 mb-4" id="order-{{ order.id }}">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Order #{{ order.id[:8] }}</strong>
                        <span class="badge bg-{{ 'success' if order.status == 'delivered' else 'warning' }} ms-2">
                            {{ order.status|title }}
                        </span>
                    </div>
                    <div>
                        <small class="text-muted" data-datetime="{{ order.created_at }}">{{ order.created_at[:19] }}</small>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        {% for item in order.items %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex">
                                {% if item.dish_image %}
                                <img src="{{ item.dish_image }}" class="rounded me-2" style="width: 60px; height: 60px; object-fit: cover;">
                                {% endif %}
                                <div>
                                    <strong>{{ item.dish_name }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        Qty: {{ item.quantity }} Ã— ${{ item.price|round(2) }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Total: ${{ order.total|round(2) }}</strong>
                            {% if order.discount_applied > 0 %}
                            <br><small class="text-success">Discount: -${{ order.discount_applied|round(2) }}</small>
                            {% endif %}
                            {% if order.delivery_fee is defined and order.delivery_fee > 0 %}
                                {% if order.free_delivery %}
                                <br><small class="text-success"><i class="fas fa-gift"></i> Free Delivery Applied (Saved ${{ order.delivery_fee|round(2) }})</small>
                                {% else %}
                                <br><small class="text-muted">Delivery Fee: ${{ order.delivery_fee|round(2) }}</small>
                                {% endif %}
                            {% elif order.delivery_bid %}
                                {% if order.free_delivery %}
                                <br><small class="text-success"><i class="fas fa-gift"></i> Free Delivery Applied (Saved ${{ order.delivery_bid|round(2) }})</small>
                                {% else %}
                                <br><small class="text-muted">Delivery: ${{ order.delivery_bid|round(2) }}</small>
                                {% endif %}
                            {% endif %}
                            {% if order.delivery_address %}
                            <br><small class="text-muted"><i class="fas fa-map-marker-alt"></i> {{ order.delivery_address }}</small>
                            {% endif %}
                        </div>
                        
                        {% if order.status == 'delivered' and not order.food_rating %}
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#ratingModal{{ order.id }}">
                            <i class="fas fa-star"></i> Rate Order
                        </button>
                        {% elif order.food_rating %}
                        <div>
                            <small class="text-muted">Food: 
                                {% for i in range(5) %}
                                    {% if i < order.food_rating %}
                                    <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                    <i class="far fa-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                            </small>
                            {% if order.delivery_rating %}
                            <br><small class="text-muted">Delivery: 
                                {% for i in range(5) %}
                                    {% if i < order.delivery_rating %}
                                    <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                    <i class="far fa-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                            </small>
                            {% endif %}
                            {% if session.user.role in ['customer', 'vip'] %}
                            <br>
                            <button class="btn btn-sm btn-outline-danger mt-2" data-bs-toggle="modal" data-bs-target="#complaintModal{{ order.id }}">
                                <i class="fas fa-exclamation-triangle"></i> File Complaint/Compliment
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Rating Modal -->
            {% if order.status == 'delivered' and not order.food_rating %}
            <div class="modal fade" id="ratingModal{{ order.id }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Rate Your Order</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="ratingForm{{ order.id }}">
                                <input type="hidden" name="order_id" value="{{ order.id }}">
                                <input type="hidden" name="dish_id" value="{{ order.items[0].dish_id }}">
                                
                                <div class="mb-3">
                                    <label>Food Rating</label>
                                    <div class="rating-input">
                                        {% for i in range(5, 0, -1) %}
                                        <input type="radio" name="food_rating" value="{{ i }}" id="food{{ order.id }}_{{ i }}" required>
                                        <label for="food{{ order.id }}_{{ i }}" class="star-label">
                                            <i class="fas fa-star"></i>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                {% if order.delivery_person_id %}
                                <div class="mb-3">
                                    <label>Delivery Rating</label>
                                    <div class="rating-input">
                                        {% for i in range(5, 0, -1) %}
                                        <input type="radio" name="delivery_rating" value="{{ i }}" id="delivery{{ order.id }}_{{ i }}">
                                        <label for="delivery{{ order.id }}_{{ i }}" class="star-label">
                                            <i class="fas fa-star"></i>
                                        </label>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" name="delivery_person_id" value="{{ order.delivery_person_id }}">
                                </div>
                                {% endif %}
                                
                                <div class="mb-3">
                                    <label for="comment{{ order.id }}">Comment (Optional)</label>
                                    <textarea class="form-control" id="comment{{ order.id }}" name="comment" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitRating('{{ order.id }}')">Submit Rating</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
        <!-- Complaint/Compliment Modal -->
        {% if order.status == 'delivered' and order.food_rating and session.user.role in ['customer', 'vip'] %}
        <div class="modal fade" id="complaintModal{{ order.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">File Complaint/Compliment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="complaintForm{{ order.id }}">
                            <div class="mb-3">
                                <label class="form-label">About</label>
                                <select class="form-select" id="targetType{{ order.id }}" onchange="updateComplaintTarget('{{ order.id }}')" required>
                                    <option value="">Select...</option>
                                    {% if order.items and order.items[0].dish_id %}
                                        {% set first_item = order.items[0] %}
                                        {% if first_item.dish and first_item.dish.chef_id %}
                                        <option value="chef" data-target-id="{{ first_item.dish.chef_id }}">Chef ({{ first_item.dish.chef_name or 'Unknown' }})</option>
                                        {% endif %}
                                    {% endif %}
                                    {% if order.delivery_person_id %}
                                    <option value="delivery" data-target-id="{{ order.delivery_person_id }}">Delivery Person ({{ order.delivery_person_name or 'Unknown' }})</option>
                                    {% endif %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Type</label>
                                <select class="form-select" id="complaintType{{ order.id }}" required>
                                    <option value="complaint">Complaint</option>
                                    <option value="compliment">Compliment</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="complaintDescription{{ order.id }}" rows="4" required></textarea>
                            </div>
                            <input type="hidden" id="targetId{{ order.id }}">
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitComplaint('{{ order.id }}')">Submit</button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-shopping-bag fa-4x text-muted mb-3"></i>
        <p class="text-muted">No orders yet. <a href="/menu">Browse menu</a> to get started!</p>
    </div>
    {% endif %}
</div>

<script>
function updateComplaintTarget(orderId) {
    const select = document.getElementById('targetType' + orderId);
    if (!select) return;
    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption && selectedOption.value) {
        const targetId = selectedOption.getAttribute('data-target-id');
        const targetIdInput = document.getElementById('targetId' + orderId);
        if (targetIdInput && targetId) {
            targetIdInput.value = targetId;
        }
    }
}

function submitComplaint(orderId) {
    const targetTypeEl = document.getElementById('targetType' + orderId);
    const targetIdEl = document.getElementById('targetId' + orderId);
    const complaintTypeEl = document.getElementById('complaintType' + orderId);
    const descriptionEl = document.getElementById('complaintDescription' + orderId);
    
    if (!targetTypeEl || !targetIdEl || !complaintTypeEl || !descriptionEl) {
        alert('Form elements not found');
        return;
    }
    
    const targetType = targetTypeEl.value;
    const targetId = targetIdEl.value;
    const complaintType = complaintTypeEl.value;
    const description = descriptionEl.value.trim();
    
    if (!targetType || !targetId || !description) {
        alert('Please fill all fields and select who to file about');
        return;
    }
    
    $.ajax({
        url: '/api/v1/complaint',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            target_id: targetId,
            target_type: targetType,
            complaint_type: complaintType,
            description: description
        }),
        success: function(response) {
            if (response.success) {
                alert(response.message || 'Complaint/compliment filed successfully!');
                $('#complaintModal' + orderId).modal('hide');
                location.reload();
            } else {
                alert(response.message || 'Failed to file complaint/compliment');
            }
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.message || 'Error filing complaint/compliment';
            alert(errorMsg);
        }
    });
}

function submitRating(orderId) {
    const form = document.getElementById('ratingForm' + orderId);
    
    // Get the selected food rating radio button
    const foodRatingInput = form.querySelector('input[name="food_rating"]:checked');
    if (!foodRatingInput) {
        alert('Please select a food rating');
        return;
    }
    
    const foodRating = parseInt(foodRatingInput.value);
    if (isNaN(foodRating) || foodRating < 1 || foodRating > 5) {
        alert('Invalid food rating');
        return;
    }
    
    const formData = new FormData(form);
    
    const data = {
        order_id: formData.get('order_id'),
        dish_id: formData.get('dish_id'),
        food_rating: foodRating,
        comment: formData.get('comment') || ''
    };
    
    // Get delivery rating if provided
    const deliveryRatingInput = form.querySelector('input[name="delivery_rating"]:checked');
    if (deliveryRatingInput) {
        const deliveryRating = parseInt(deliveryRatingInput.value);
        if (!isNaN(deliveryRating) && deliveryRating >= 1 && deliveryRating <= 5) {
            data.delivery_rating = deliveryRating;
            data.delivery_person_id = formData.get('delivery_person_id');
        }
    }
    
    console.log('Submitting rating:', data);
    
    $.ajax({
        url: '/api/v1/rating',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert(response.message || 'Failed to submit rating');
            }
        },
        error: function(xhr) {
            console.error('Rating submission error:', xhr);
            const errorMsg = xhr.responseJSON?.message || 'Error submitting rating';
            alert(errorMsg);
        }
    });
}
</script>

<style>
.rating-input {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
}
.rating-input input[type="radio"] {
    display: none;
}
.rating-input label {
    cursor: pointer;
    color: #ddd;
    font-size: 1.5rem;
    margin-right: 5px;
}
.rating-input input[type="radio"]:checked ~ label,
.rating-input label:hover,
.rating-input label:hover ~ label {
    color: #ffc107;
}
</style>
{% endblock %}
